---
output: html_document
editor_options: 
 chunk_output_type: console
---

# Congressional District summary analysis

## Setup

```{r}
#| label: setup
#| output: false

source(here::here("R", "libraries.R"))
source(here::here("R", "functions.R"))
source(here::here("R", "functions_constants.R"))

```

```{r}
#| label: constants
#| output: false

AREA_TYPE <- "cd" # if want to redefine constants

CONSTANTS <- get_constants(AREA_TYPE)
# CONSTANTS

```


```{r}
#| label: get-data
#| output: false

compfile <- readr::read_csv(fs::path(CONSTANTS$OUTPUT_DIR, "compfile.csv"),
                                             show_col_types = FALSE)

```


## Variables included in the analysis

```{r}
#| label: vars-included

vars_included <- compfile |> 
  select(varname, basesoivname, description) |> 
  distinct() 

vars_included |> 
  gt()

```


## Summary results for targeted items and untargeted items in mapped variables

### Overall summary

```{r}
#| label: overall-summary

probs <- c(0, .01, .05, .1, .25, .5, .75, .90, .95, .99, 1)

tabdata <- compfile |>
  summarise(pdiff=list(quantile(pdiff,
                                probs=probs)),
            .by=c(targeted)) |>
  mutate(targeted=ifelse(targeted, "targeted", "not_targeted")) |> 
  unnest_longer(col=pdiff) |>
  relocate(pdiff_id, pdiff) |>
  pivot_wider(names_from = targeted, values_from = pdiff)

tabdata |> 
  gt() |>
  tab_header("Overall summary: Percentage differences from potential targets") |>
  tab_spanner(label=html("Percentage above (+)<br>or below (-) target"),
              columns = c(targeted, not_targeted)) |> 
  cols_label(pdiff_id="quantile") |> 
  fmt_percent(columns = c(targeted, not_targeted),
              decimals=2)

```


### Summary by variable

```{r}
#| label: summary-by-variable
#| column: page

probs <- c(0, .01, .05, .1, .25, .5, .75, .90, .95, .99, 1)


tabdata <- compfile |>
  summarise(n=n(),
            pdiff=list(quantile(pdiff,
                                probs=probs)),
            .by=c(varname, basesoivname, description, scope, count, fstatus, targeted)) |>
  mutate(targeted=ifelse(targeted, "targeted", "not_targeted")) |> 
  unnest_longer(col=pdiff) |>
  pivot_wider(names_from = targeted, values_from = c(n, pdiff))

tabdata |> 
  rename(quantile=pdiff_id) |> 
  select(-varname) |> 
  DT::datatable(rownames = FALSE,
                options = list(scrollX = TRUE, scrollY = TRUE, paging = TRUE, pageLength = 25,
                               autoWidth = TRUE),
                filter="top",
                escape = FALSE) |>
  formatPercentage(columns = c("pdiff_targeted", "pdiff_not_targeted"),  digits = 1)

# tabdata |> 
#   gt() |>
#   tab_header("Summary by variable: Percentage differences from potential targets") |>
#   tab_spanner(label=html("Number"),
#               columns = c(n_targeted, n_not_targeted)) |> 
#   tab_spanner(label=html("Percentage above (+)<br>or below (-) target"),
#               columns = c(pdiff_targeted, pdiff_not_targeted)) |>   
#   cols_label(pdiff_id="quantile") |> 
#   fmt_percent(columns = c(pdiff_targeted, pdiff_not_targeted),
#               decimals=2)

```


## Details

```{r}
#| label: ftab
#| output: false

ftab <- function(tabdf, header, subheader){
  tabdf |> 
    select(area, scope, count, fstatus, varname, description, agistub, agilabel, target, wtdsum, diff, pdiff, targeted) |> 
    gt() |> 
    tab_header(title=header,
               subtitle = subheader) |> 
    fmt_percent(columns = pdiff, decimals=1) |> 
    fmt_currency(columns = c(target, wtdsum, diff),
                 rows = count == 0,
                 scale = 1e-9,
                 decimals = 2) |> 
    fmt_number(columns = c(target, wtdsum, diff),
                 rows = count > 0,
                 scale = 1e-3,
                 decimals = 1)
}


```


## Selected results for agistub 0 -- total amounts for variables, whether targeted or not


```{r}
#| label: top-20-pdiff-agistub0
#| column: page

tabdf <-   compfile |> 
  filter(agistub == 0, area != "us") |> 
  arrange(desc(abs(pdiff))) |> 
  filter(row_number() <= 20)

header <- "Top 20 worst percentage differences from potential target for agistub 0"
subheader <- "Amounts in $ billions, counts in thousands"

ftab(tabdf, header, subheader)

```


```{r}
#| label: top-20-diff-agistub0
#| column: page

tabdf <-   compfile |> 
  filter(agistub == 0, area != "us") |> 
  mutate(group = count==0) |> 
  arrange(group, desc(abs(diff))) |> 
  group_by(group) |> 
  filter(row_number() <= 10) |> 
  ungroup() |> 
  select(-group)

header <- "Top 10 each worst dollar and count differences from potential target, agistub 0"
subheader <- "Amounts in $ billions, counts in thousands"

ftab(tabdf, header, subheader)

```




## Selected results for targeted variables

```{r}
#| label: top-20-pdiff-targeted
#| column: page

tabdf <-   compfile |> 
  filter(targeted, area != "us") |> 
  arrange(desc(abs(pdiff))) |> 
  filter(row_number() <= 20)

header <- "Top 20 worst percentage differences from target, targeted items"
subheader <- "Amounts in $ billions, counts in thousands"

ftab(tabdf, header, subheader)

```


```{r}
#| label: top-20-diff-targeted
#| column: page

tabdf <-   compfile |> 
  filter(targeted, area != "us") |> 
  mutate(group = count==0) |> 
  arrange(group, desc(abs(diff))) |> 
  group_by(group) |> 
  filter(row_number() <= 10) |> 
  ungroup() |> 
  select(-group)

header <- "Top 10 each worst dollar and count differences from target, targeted items"
subheader <- "Amounts in $ billions, counts in thousands"

ftab(tabdf, header, subheader)


```


## Selected results for untargeted variables and unused targets

```{r}
#| label: top-20-pdiff-untargeted
#| column: page

tabdf <-   compfile |> 
  filter(!targeted, area != "us") |> 
  arrange(desc(abs(pdiff))) |> 
  filter(row_number() <= 20)

header <- "Top 20 worst percentage differences from potential target, untargeted items"
subheader <- "Amounts in $ billions, counts in thousands"

ftab(tabdf, header, subheader)

```


```{r}
#| label: top-20-diff-untargeted
#| column: page

tabdf <-   compfile |> 
  filter(!targeted, area != "us") |> 
  mutate(group = count==0) |> 
  arrange(group, desc(abs(diff))) |> 
  group_by(group) |> 
  filter(row_number() <= 10) |> 
  ungroup() |> 
  select(-group)

header <- "Top 10 each worst dollar and count differences from potential target, untargeted items"
subheader <- "Amounts in $ billions, counts in thousands"

ftab(tabdf, header, subheader)


```
