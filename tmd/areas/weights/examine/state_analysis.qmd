---
output: html_document
editor_options: 
 chunk_output_type: console
---

# State analysis

## Setup

```{r}
#| label: setup
#| output: false

source(here::here("R", "libraries.R"))
source(here::here("R", "constants.R"))
source(here::here("R", "functions.R"))

```

```{r}
#| label: constants
#| output: false

CONSTANTS <- get_constants("state")
CONSTANTS
CONSTANTS$WEIGHTS_DIR

```


## ONETIME: Get and save weights

Get and save a wide tibble of weights each time new weights are produced. Once the file is created and saved, retrieval is much faster.

```{r}
#| label: ONETIME-save-weights
#| eval: false
#| output: false

save_weights()

```

## ONETIME: Supplement the weights file with selected tmd variables and summarize

Supplement the weights with selected tmd variables and summarize. Repeat when weights change, or the tmd data change, or desired tmd variables change.


```{r}
#| label: ONETIME-save-enhanced-weighted-tmd-sums
#| eval: false
#| output: false

TAXCALC_VARS <- c("XTOT", "c00100", "e00200", "e00300", "e01500", "e02400", "e26270", "e18400", "e18500", "iitax")
save_enhanced_weighted_sums(TAXCALC_VARS)

```

## get targets

```{r}
#| label: area-tables
#| output: true

# fs::dir_ls(CDINTERMEDIATE) # we want cdbasefile_enhanced.csv, to become enhanced_targets.csv
# fs::dir_ls(CONSTANTS$TARGETS_DIR) # enhanced_targets.csv
# CONSTANTS

# areatab <- function(area, compfile){
#   compfile |>
#     filter(area==!!area) |> 
#     gt() |> 
#     fmt_number(columns = c(target, wtdsum, diff),
#                scale = 1e-6,
#                decimals = 1) |> 
#     fmt_percent(columns = pdiff,
#                 decimals = 2)
# }


compfile <- get_combined_file()
write_csv(compfile, fs::path(CONSTANTS$OUTPUT_DIR, "compfile.csv"))
# skim_without_charts(compfile)

# areas <- c("al", "ca", "ny")
# f <- function(area){
#   header <- paste0("## Comparison to potential targets for: ", area, "\n")
#   cat(header)
#   tab <- areatab(area, compfile)
#   print(tab)
# }
# purrr::walk(areas, f)


# areatab <- function(compfile){
#   compfile |>
#     filter(area == "{{area}}") |> 
#     gt() |>  
#     tab_header(title = paste("Results for", "{{area}}")) |> 
#     fmt_number(columns = c(target, wtdsum, diff),
#                scale = 1e-6,
#                decimals = 1) |> 
#     fmt_percent(columns = pdiff,
#                 decimals = 2)
# }

```



```{r}
#| results: asis
#| echo: false

areas <- c("al", "ca", "ny")
# area <- "ca"
for(area in areas) {
    template <- readLines("_area-template_dt.qmd")
    template <- str_replace_all(template, coll("{{area}}"), area)
    cat(knitr::knit_child(text = template, quiet = TRUE))
    cat("\n\n")
}

```

