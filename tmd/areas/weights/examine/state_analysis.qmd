---
output: html_document
editor_options: 
 chunk_output_type: console
---

# State analysis

## Setup

```{r}
#| label: setup
#| output: false

source(here::here("R", "libraries.R"))
source(here::here("R", "constants.R"))
source(here::here("R", "functions.R"))

```

```{r}
#| label: constants

CONSTANTS <- get_constants("state")
CONSTANTS
CONSTANTS$WEIGHTS_DIR

```


## ONETIME: Get and save weights

Get and save a wide tibble of weights each time new weights are produced. Once the file is created and saved, retrieval is much faster.

```{r}
#| label: ONETIME-save-weights
#| eval: false
#| output: false

save_weights()

```

## ONETIME: Supplement the weights file with selected tmd variables and summarize

Supplement the weights with selected tmd variables and summarize. Repeat when weights change, or the tmd data change, or desired tmd variables change.


```{r}
#| label: ONETIME-save-enhanced-weighted-tmd-sums
#| eval: false
#| output: false

TAXCALC_VARS <- c("XTOT", "c00100", "e00200", "e00300", "e01700", "e26270", "e18400", "e18500", "iitax")
save_enhanced_weighted_sums(TAXCALC_VARS)

```

## get targets

```{r}

# fs::dir_ls(CDINTERMEDIATE) # we want cdbasefile_enhanced.csv, to become enhanced_targets.csv
# fs::dir_ls(CONSTANTS$TARGETS_DIR) # enhanced_targets.csv
# CONSTANTS
CONSTANTS

files <- fs::dir_ls(CONSTANTS$WEIGHTS_DIR)

csvs <- files |> str_subset("targets.csv")
targets_used <- vroom::vroom(csvs, id="area") |> 
  mutate(area=fs::path_file(area),
         area=stringr::word(area, sep = "_")) # , area=stringr::str_to_upper(area)
count(targets_used, area)

targets_data <- read_csv(fs::path(CONSTANTS$TARGETS_DIR, "enhanced_targets.csv"))
glimpse(targets_data)
count(targets_data, agistub, agilo, agihi, agilabel)

wtdsums <- readr::read_csv(fs::path(CONSTANTS$OUTPUT_DIR, "wtdsums_enhanced.csv"))
vmap <- read_csv(fs::path(CONSTANTS$RECIPES_DIR, paste0(CONSTANTS$AREA_TYPE, "_variable_mapping.csv")))
names(wtdsums)
count(wtdsums, varname)
count(wtdsums, MARS)
count(wtdsums, data_source)
vmap

df <- wtdsums |> 
  rename(fstatus = MARS) |> 
  mutate(scope = case_when(data_source == 0 ~ 2, # cps only
                           data_source == 1 ~ 1, # puf only
                           data_source == 9 ~ 0, # all records
                           .default = -9), # ERROR
         count = case_when(valuetype == "sum" ~ 0,
                           valuetype == "anycount" ~ 1,
                           valuetype == "nzcount" ~ 2,
                           .default = -9) # ERROR
         ) |> 
  left_join(vmap, relationship = "many-to-many",
            by = join_by(fstatus, varname))

# |>   left_join(targets_used |> select(-target))

df |> filter(row_number() == 83311)

df2 <- df |> 
  left_join(targets_data |> 
              mutate(area = str_to_lower(stabbr)) |> 
              select(-description),
            by = join_by(area, scope, count, fstatus, basesoivname, agistub)) |> 
  left_join(targets_used |> 
              select(-target) |> 
              mutate(used = TRUE),
            by = join_by(area, fstatus, varname, scope, count, agilo, agihi))|> 
  mutate(used = ifelse(is.na(used), FALSE, TRUE))

skim(df2)

head(df2)

df3 <- df2 |> 
  filter(!is.na(stabbr))

check <- df3 |> filter(area=="ny") |> arrange(sort)
glimpse(check)

check |> 
  select(area, scope, fstatus, count, varname, basesoivname, agistub, agilabel, sort, target, wtdsum) |> 
  mutate(diff = wtdsum - target,
         pdiff = diff / target) |> 
  gt() |> 
  fmt_number(columns = c(target, wtdsum, diff),
             scale = 1e-6,
             decimals = 1) |> 
  fmt_percent(columns = pdiff,
              decimals = 2)
  

# vmap <- read_csv(fs::path(CDINTERMEDIATE, "cd_variable_mapping.csv"))
# wtditems <- read_csv(here::here("intermediate", "wtditems_enhanced.csv"))
# targets_data <- readRDS(here::here("temp_data", "targets_data.rds"))
# targets_used <- readRDS(here::here("temp_data", "targets_used.rds"))

```


## Analysis

```{r}
#| label: explore
#| output: false

wtdsums <- read_csv(here::here("intermediate", paste0(area_type, "_wtditems_enhanced.csv")))


```



## more

```{r}
#| label: more
#| output: false

```


