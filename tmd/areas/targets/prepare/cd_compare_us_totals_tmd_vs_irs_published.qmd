---
output: html_document
editor_options: 
 chunk_output_type: console
---

# Compare U.S. totals of mapped variables, tax-microdata-benchmarking vs. IRS published CD values


## Setup 
```{r}
#| label: setup

source(here::here("R", "libraries.R"))
source(here::here("R", "constants.R"))
source(here::here("R", "functions.R"))

```

## Get data

```{r}
#| label: get-data
#| output: false

vmap <- read_csv(fs::path(CDINTERMEDIATE, "cd_variable_mapping.csv"))
cdirs <- read_csv(fs::path(CDINTERMEDIATE, "cdbasefile_sessions.csv"))

TMDDIR <- here::here("..", "..", "..", "storage", "output")
fpath <-  fs::path(TMDDIR, "cached_allvars.csv")
tmd2021 <- vroom(fpath)
ns(tmd2021)

```

## Create comparison file

Prepare Congressional district data.

```{r}
#| label: prepare-cd-data
#| output: false

# vmap

cd2 <- cdirs |> 
  filter(basevname %in% vmap$basevname,
         session==118,
         scope==1 | basevname=="XTOT")

count(cd2, basevname, vname)
count(cd2, rectype)
count(cd2, scope)
count(cd2, fstatus)
count(cd2 |> filter(str_detect(vname, "MARS")), 
      vname, fstatus)
skim(cd2)

cd3 <- cd2 |> 
  summarise(target=sum(target),
            .by=c(basevname, count, agistub, agirange, description))

```

Prepare tmd data

```{r}
#| label: prepare-tmd-data
#| eval: false
#| output: false

# icuts <- c(-Inf, 1, 10e3, 25e3, 50e3, 75e3, 100e3, 200e3, 500e3, Inf)
# icuts <- CDICUTS

# 0 = Total
# 1 = Under $1
# 2 = $1 under $10,000
# 3 = $10,000 under $25,000
# 4 = $25,000 under $50,000
# 5 = $50,000 under $75,000
# 6 = $75,000 under $100,000
# 7 = $100,000 under $200,000
# 8 = $200,000 under $500,000
# 9 = $500,000 or more

vmap

vmap2 <- vmap |> 
  mutate(varname=ifelse(str_starts(basevname, "MARS"),
                        basevname,
                        varname))

agicuts <- c(-Inf, 1, 10e3, 25e3, 50e3, 75e3, 100e3, 200e3, 500e3, Inf)


