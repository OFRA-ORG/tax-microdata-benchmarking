---
output: html_document
editor_options: 
 chunk_output_type: console
---

# Prepare SOI documentation files

## Setup

```{r}
#| label: setup

source(here::here("R", "libraries.R"))
source(here::here("R", "constants.R"))
source(here::here("R", "functions.R"))

```


```{r}
#| label: read-data
#| output: false

# DRAW <- here::here("data", "data_raw")

# read_csv(fs::path(DINTERMEDIATE, "soi_documentation.csv")) # uniform descriptions, else by_year

# variable_descriptions <- read_csv(fs::path(DINTERMEDIATE, "soi_documentation.csv"))
variable_descriptions <- read_csv(fs::path(DINTERMEDIATE, "soi_documentation_by_year.csv"))

csvfiles <- dir_ls(DRAW, glob="*.csv")

get_csvdata <- function(csvfile){
  year <- paste0("20", str_sub(fs::path_file(csvfile), 1, 2))
  print(year)
  vroom(csvfile) |> 
    mutate(year=year)
}

csvdata <- purrr::map(csvfiles, get_csvdata) |> 
  list_rbind()
count(csvdata, year)

csvdata2 <- csvdata |> 
  rename_with(str_to_lower) |> 
  rename(stabbr=state, agistub=agi_stub) |> 
  mutate(year=as.integer(year)) |> 
  pivot_longer(-c(stabbr, year, agistub),
               names_to = "vname") |> 
  left_join(variable_descriptions,
            by = join_by(vname, year))

skim(csvdata2)
glimpse(csvdata2)

# data checks

# csvdata2 |> 
#   filter(is.na(vtype)) |> 
#   count(vname)


csvdata2 |> 
  filter(str_sub(vname, 1, 3)=="a18") |> 
  count(vname, year, udescription, description)

csvdata2 |> filter(vname=="a18460", year==2015)

count(csvdata2, stabbr) # 54 -- 50 + US, DC, PR, OA

csvdata2 |> 
  filter(vname=="a18460", year %in% 2015:2017) |> 
  skim()

csvdata2 |> 
  filter(stabbr=="US", agistub==0, vtype=="amount", str_starts(basename, "184")) |> 
  arrange(name, year)

# a18425 drops 2018+ 369 --> 201
# a8450 drops 2018+ 20 --> 9
# a18460 2018+ 130 ish

salt <- df3 |> 
  filter(year %in% c(2017, 2018, 2021),
         name=="a18425",
         agistub==0,
         !stabbr %in% c("US", "OA", "PR")) |> 
  select(stabbr, year, value) |> 
  pivot_wider(names_from = year, names_prefix = "y")

salt |> select(-stabbr) |> cor()

salt |> 
  filter(!stabbr %in% c("CA", "NY")) |> 
  ggplot(aes(x=y2017, y=y2021)) +
  geom_point(colour="blue",
             size=0.5) +
  geom_text(aes(label=stabbr),
            colour="blue",
            size=3) +
  theme_bw()

```

