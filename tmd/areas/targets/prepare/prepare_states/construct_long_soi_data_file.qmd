---
output: html_document
editor_options: 
 chunk_output_type: console
---

# Prepare SOI documentation files

## Setup

```{r}
#| label: setup

source(here::here("R", "libraries.R"))
source(here::here("R", "constants.R"))
source(here::here("R", "functions.R"))

```


```{r}
#| label: read-data
#| output: false

DRAW <- here::here("data", "data_raw")

csvfiles <- dir_ls(DRAW, glob="*.csv")

f <- function(csvfile){
  year <- paste0("20", str_sub(fs::path_file(csvfile), 1, 2))
  print(year)
  vroom(csvfile) |> 
    mutate(year=year)
}

df <- purrr::map(csvfiles, f) |> 
  list_rbind()
count(df, year)

df2 <- df |> 
  rename_with(str_to_lower) |> 
  rename(stabbr=state, agistub=agi_stub) |> 
  pivot_longer(-c(stabbr, year, agistub))

vnames <- count(df2, name) |> 
  mutate(length=nchar(name),
         vtype=case_when(
           name == "numdep" ~ "count",
           length != 6 ~ "count",
           length == 6 & str_sub(name, 1, 1) == "n" ~ "count",
           length == 6 & str_sub(name, 1, 1) == "a" ~ "amount",
           .default = "ERROR")
         )
count(vnames, vtype)

df3 <- df2 |> 
  left_join(vnames |> select(name, vtype, length),
            by = join_by(name)) |> 
  mutate(basename=case_when(
    name == "numdep" ~ "numdep",
    length == 6 ~ str_sub(name, 2, 6),
    .default = name
  )) |> 
  select(-length)
count(df3, vtype)

df3 |> 
  filter(str_sub(name, 1, 3)=="a18") |> 
  count(name, year)

count(df3, stabbr) # 54 -- 50 + US, DC, PR, OA

df3 |> 
  filter(stabbr=="US", agistub==0, vtype=="amount", str_starts(basename, "184")) |> 
  arrange(name, year)

# a18425 drops 2018+ 369 --> 201
# a8450 drops 2018+ 20 --> 9
# a18460 2018+ 130 ish

salt <- df3 |> 
  filter(year %in% c(2017, 2018, 2021),
         name=="a18425",
         agistub==0,
         !stabbr %in% c("US", "OA", "PR")) |> 
  select(stabbr, year, value) |> 
  pivot_wider(names_from = year, names_prefix = "y")

salt |> select(-stabbr) |> cor()

salt |> 
  filter(!stabbr %in% c("CA", "NY")) |> 
  ggplot(aes(x=y2017, y=y2021)) +
  geom_point(colour="blue",
             size=0.5) +
  geom_text(aes(label=stabbr),
            colour="blue",
            size=3) +
  theme_bw()

```

