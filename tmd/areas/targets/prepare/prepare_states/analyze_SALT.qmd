---
output: html_document
editor_options: 
  chunk_output_type: console
---



```{r}

soilong <- readRDS(fs::path(DINTERMEDIATE, "soilong.rds"))

# data checks

soilong |>
  filter(is.na(vtype)) |>
  count(vname)

soilong |> 
  filter(str_sub(vname, 1, 3)=="a18") |> 
  count(vname, year, udescription, description)

soilong |> filter(vname=="a18460", year==2015)

count(soilong, stabbr) # 54 -- 50 + US, DC, PR, OA

soilong |> 
  filter(vname=="a18460", year %in% 2015:2017) |> 
  skim()

soilong |> 
  filter(stabbr=="US", agistub==0, vtype=="amount", str_starts(basevname, "184")) |> 
  arrange(vname, year)

# a18425 drops 2018+ 369 --> 201
# a8450 drops 2018+ 20 --> 9
# a18460 2018+ 130 ish

salt <- soilong |> 
  filter(year %in% c(2017, 2018, 2021),
         vname=="a18425",
         agistub==0,
         !stabbr %in% c("US", "OA", "PR")) |> 
  select(stabbr, year, value) |> 
  pivot_wider(names_from = year, names_prefix = "y")

salt |> select(-stabbr) |> cor()

salt |> 
  filter(!stabbr %in% c("CA", "NY")) |> 
  ggplot(aes(x=y2017, y=y2021)) +
  geom_point(colour="blue",
             size=0.5) +
  geom_text(aes(label=stabbr),
            colour="blue",
            size=3) +
  theme_bw()
```

